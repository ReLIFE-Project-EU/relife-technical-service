# GitHub Actions workflow to run smoke tests ensuring the API starts without errors
name: Smoke Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering from GitHub UI

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Docker Buildx for building the image
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Build the Docker image
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: relife-technical:smoke-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Step 4: Start the API container
      - name: Start API container
        run: |
          CID=$(docker run -d \
            --name relife-api \
            -p 9090:9090 \
            -e API_HOST=0.0.0.0 \
            -e API_PORT=9090 \
            -e SUPABASE_URL=http://localhost:54321 \
            -e SUPABASE_KEY=dummy-key-for-testing \
            -e KEYCLOAK_CLIENT_ID=test-client \
            -e KEYCLOAK_CLIENT_SECRET=test-secret \
            relife-technical:smoke-test)
          echo "CONTAINER_ID=$CID" >> $GITHUB_ENV

      # Step 5: Wait for API to be ready and test OpenAPI docs
      - name: Wait for API and test OpenAPI endpoint
        timeout-minutes: 1
        run: |
          echo "Waiting for API to be ready..."
          for i in {1..30}; do
            if curl -fsSL http://localhost:9090/docs > /dev/null 2>&1; then
              echo "✓ API is ready and OpenAPI docs accessible (attempt $i/30)"
              exit 0
            fi
            echo "Attempt $i/30: API not ready yet..."
            sleep 1
          done
          echo "✗ API failed to start within 30 seconds"
          exit 1

      # Step 6: Show container logs (useful for debugging failures)
      - name: Show container logs
        if: always()
        run: docker logs relife-api

      # Step 7: Clean up - stop and remove the container
      - name: Stop and remove container
        if: always()
        run: |
          docker stop relife-api || true
          docker rm relife-api || true
